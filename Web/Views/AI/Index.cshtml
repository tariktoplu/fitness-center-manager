@model Web.Models.ViewModels.AIRequestViewModel

@{
    ViewData["Title"] = "AI Antrenör";
}

<!-- Vue.js CDN -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

<div id="vue-app" class="container mt-5">
    <!-- Başlık -->
    <div class="text-center mb-5 animate__animated animate__fadeInDown">
        <h1 class="display-4 fw-bold text-primary"><i class="bi bi-robot"></i> AI Fitness Asistanı</h1>
        <p class="lead text-muted">Google Gemini AI destekli kişisel analiz ve program.</p>
    </div>

    <div class="row">
        <!-- SOL TARAF: Form -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-lg border-0 bg-white animate__animated animate__fadeInLeft">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-sliders"></i> Vücut Bilgileri</h5>
                </div>
                <div class="card-body p-4">
                    <!-- v-on:submit.prevent formun sayfayı yenilemesini engeller -->
                    <form v-on:submit.prevent="analizEt">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Boy (cm)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-rulers"></i></span>
                                <input v-model="form.height" type="number" class="form-control form-control-lg" placeholder="175" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Kilo (kg)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-speedometer2"></i></span>
                                <input v-model="form.weight" type="number" class="form-control form-control-lg" placeholder="75" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Hedefiniz</label>
                            <select v-model="form.goal" class="form-select form-select-lg">
                                <option>Kilo Vermek</option>
                                <option>Kas Kütlesi Kazanmak</option>
                                <option>Formu Korumak</option>
                                <option>Daha Enerjik Olmak</option>
                            </select>
                        </div>

                        <div class="d-grid mt-4">
                            <!-- Yüklenirken Buton Pasif -->
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow-sm" :disabled="loading">
                                <span v-if="loading">
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    Analiz Ediliyor...
                                </span>
                                <span v-else>
                                    <i class="bi bi-magic me-2"></i> Analiz Et
                                </span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- SAĞ TARAF: Sonuç Ekranı -->
        <div class="col-md-8">
            
            <!-- DURUM 1: Yükleniyor -->
            <div v-if="loading" class="text-center mt-5 pt-4 animate__animated animate__fadeIn">
                <div class="spinner-grow text-primary mb-3" style="width: 4rem; height: 4rem;" role="status"></div>
                <h3 class="text-primary fw-bold animate__animated animate__pulse animate__infinite">Yapay Zeka Düşünüyor...</h3>
                <p class="text-muted fs-5">Size özel program hazırlanıyor, lütfen bekleyin.</p>
            </div>

            <!-- DURUM 2: Sonuç Geldi -->
            <div v-else-if="result" class="card shadow-lg border-0 animate__animated animate__fadeInUp">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="bi bi-check-circle-fill me-2"></i> Analiz Raporu</h4>
                    <span class="badge bg-light text-success fs-6 border">{{ bmiResult }}</span>
                </div>
                <div class="card-body p-4 ai-content">
                    <!-- HTML Çıktısını Bas -->
                    <div v-html="result"></div>
                </div>
                <div class="card-footer text-end bg-light">
                    <small class="text-muted fst-italic">
                        <i class="bi bi-google me-1"></i> Powered by Google Gemini AI
                    </small>
                </div>
            </div>

            <!-- DURUM 3: Boş Ekran -->
            <div v-else class="text-center mt-5 pt-5 text-muted opacity-50 animate__animated animate__fadeIn">
                <i class="bi bi-cpu-fill" style="font-size: 7rem;"></i>
                <h3 class="mt-3">Sonuçlar burada görünecek</h3>
                <p>Sol taraftan bilgilerinizi girip butona basın.</p>
            </div>

        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                loading: false,
                form: {
                    height: '', // Boş string ile başlatıyoruz
                    weight: '',
                    goal: 'Kilo Vermek'
                },
                result: null,
                bmiResult: ''
            }
        },
        methods: {
            async analizEt() {
                // 1. Yüklemeyi Başlat
                this.loading = true;
                this.result = null;

                try {
                    // Controller'daki Route ile aynı olmalı: /AI/Analyze
                    const response = await fetch('/AI/Analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.form)
                    });

                    // Sunucudan hata dönerse JSON parse etmeden önce yakala
                    if (!response.ok) {
                        throw new Error(`Sunucu Hatası: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        this.result = data.htmlContent;
                        this.bmiResult = data.bmi;
                        
                        // SweetAlert Başarılı Mesajı
                        Swal.fire({
                            icon: 'success',
                            title: 'Analiz Tamamlandı!',
                            timer: 1500,
                            showConfirmButton: false,
                            position: 'top-end',
                            toast: true
                        });
                    } else {
                        Swal.fire('Hata', data.message || 'Bir sorun oluştu.', 'error');
                    }
                } catch (error) {
                    console.error(error);
                    Swal.fire('Bağlantı Hatası', 'Sunucuya ulaşılamadı veya bir hata oluştu.', 'error');
                } finally {
                    // 2. Yüklemeyi Bitir
                    this.loading = false;
                }
            }
        }
    }).mount('#vue-app');
</script>

<style>
    /* AI İçerik Stilleri */
    .ai-content h3 { color: #198754; font-weight: 700; margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 2px solid #e9ecef; padding-bottom: 0.5rem; }
    .ai-content ul { padding-left: 1.2rem; }
    .ai-content li { margin-bottom: 0.5rem; }
    .ai-content p { line-height: 1.6; color: #495057; }
</style>